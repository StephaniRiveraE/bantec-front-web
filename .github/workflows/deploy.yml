name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: SECRET_BANTEC
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 60m
          script: |
            # --- Ensure swap exists for memory-intensive builds ---
            if [ ! -f /swapfile ]; then
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # --- Setup project directory ---
            if [ ! -d ~/BnacoBantec ]; then
              cd ~
              git clone https://github.com/AlisonTamayo/BnacoBantec.git
            fi

            cd ~/BnacoBantec
            git fetch origin main
            git reset --hard origin/main

            # --- Prepare SSL/mTLS Certificates ---
            echo "üîê Verificando certificados..."

            # 1. mTLS (Banco <-> Switch)
            if [ ! -f ~/BnacoBantec/ms-transaccion/src/main/resources/certs/bantec-keystore.p12 ]; then
              echo "üìù Generando certificados mTLS por defecto..."
              chmod +x ~/BnacoBantec/generate-mtls-certs.sh
              ~/BnacoBantec/generate-mtls-certs.sh
            fi

            # 2. Nginx SSL (HTTPS)
            mkdir -p ~/BnacoBantec/nginx/certs
            if [ ! -f ~/BnacoBantec/nginx/certs/fullchain.pem ]; then
              echo "üìù Generando certificados SSL autofirmados para Nginx..."
              openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout ~/BnacoBantec/nginx/certs/privkey.pem \
                -out ~/BnacoBantec/nginx/certs/fullchain.pem \
                -subj "/C=EC/ST=Pichincha/L=Quito/O=Bantec/CN=35.209.225.8"
            fi

            # --- Build and deploy using docker-compose ---
            echo "üöÄ Construyendo y desplegando contenedores..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            # --- Clean up unused Docker resources ---
            sudo docker image prune -f

            # --- Ensure nginx is restarted with new config ---
            sudo docker restart nginx-proxy-bantec || true

            echo "‚úÖ BANTEC Deploy completado: $(date)"
