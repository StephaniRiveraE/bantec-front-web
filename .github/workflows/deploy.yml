name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy BANTEC via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            echo "üìå Inicio de deploy BANTEC: $(date)"

            # 1. Crear swap si no existe (vital para compilaci√≥n Java/React en VM peque√±a)
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB por seguridad..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # 2. Clonar o actualizar repositorio
            if [ ! -d ~/BnacoBantec ]; then
              echo "üì• Clonando repositorio BANTEC..."
              cd ~
              git clone https://github.com/AlisonTamayo/BnacoBantec.git
            fi

            cd ~/BnacoBantec
            echo "üîÑ Sincronizando c√≥digo con la rama main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # 3. Preparar certificados mTLS (Comunicaci√≥n con el Switch)
            echo "üîê Verificando certificados mTLS..."
            CERT_SOURCE="~/BnacoBantec/ms-transaccion/src/main/resources/certs"
            TARGET_MTLS="~/bantec_certs"
            
            if [ ! -f $CERT_SOURCE/bantec-keystore.p12 ]; then
              echo "üõ†Ô∏è Generando nuevos certificados mTLS..."
              chmod +x ~/BnacoBantec/generate-mtls-certs.sh
              ~/BnacoBantec/generate-mtls-certs.sh
            fi
            
            # Asegurar que existan para el montaje de Docker volumes
            mkdir -p $TARGET_MTLS
            cp -r $CERT_SOURCE/* $TARGET_MTLS/
            chmod 777 $TARGET_MTLS/*

            # 4. Certificados SSL HTTPS (Let's Encrypt / DuckDNS)
            echo "üåê Automatizando SSL para ${{ secrets.DUCKDNS_DOMAIN }}.duckdns.org..."
            CERT_HOST_DIR="~/BnacoBantec/nginx/certs/live/bantec-bank.duckdns.org"
            
            # 4.1 Actualizar IP en DuckDNS si hay token
            if [ -n "${{ secrets.DUCKDNS_TOKEN }}" ]; then
              chmod +x ~/BnacoBantec/update_duckdns.sh
              ~/BnacoBantec/update_duckdns.sh "${{ secrets.DUCKDNS_DOMAIN }}" "${{ secrets.DUCKDNS_TOKEN }}"
            fi

            # Asegurar que los directorios existan
            mkdir -p ~/BnacoBantec/nginx/certs
            mkdir -p ~/BnacoBantec/nginx/certbot

            # Detectar si el certificado es real o necesita reemplazo
            NEEDS_CERT=false
            if [ ! -f $CERT_HOST_DIR/fullchain.pem ]; then
              NEEDS_CERT=true
            else
              # Si existe pero es autofirmado (temporal), tambi√©n necesitamos el real
              if ! sudo openssl x509 -in $CERT_HOST_DIR/fullchain.pem -noout -issuer | grep -q "Let's Encrypt"; then
                echo "‚ö†Ô∏è Certificado actual es temporal/autofirmado. Intentando obtener real..."
                NEEDS_CERT=true
              fi
            fi

            if [ "$NEEDS_CERT" = true ]; then
              echo "üõ°Ô∏è Iniciando proceso de obtenci√≥n de certificado real..."
              
              # Si no hay nada, creamos uno temporal para que Nginx arranque
              if [ ! -f $CERT_HOST_DIR/fullchain.pem ]; then
                echo "üìù Creando dummy cert para arranque inicial..."
                sudo mkdir -p $CERT_HOST_DIR
                sudo openssl req -x509 -nodes -days 7 -newkey rsa:2048 \
                  -keyout $CERT_HOST_DIR/privkey.pem \
                  -out $CERT_HOST_DIR/fullchain.pem \
                  -subj "/C=EC/ST=Pichincha/L=Quito/O=Bantec/CN=bantec-bank.duckdns.org"
              fi

              # Levantamos Nginx para responder al challenge
              echo "üöÄ Arrancando Nginx para validaci√≥n..."
              sudo docker-compose -f docker-compose.prod.yml up -d nginx-proxy

              echo "üì° Solicitando certificado a Let's Encrypt..."
              # Borramos el temporal justo antes para que Certbot no se confunda si es posible
              # Pero Nginx lo necesita para estar arriba. Certbot --webroot no necesita que el puerto 80 est√© libre, solo que Nginx sirva /.well-known/
              sudo docker run --rm --name certbot-issuance \
                -v "$(pwd)/nginx/certs:/etc/letsencrypt" \
                -v "$(pwd)/nginx/certbot:/var/www/certbot" \
                certbot/certbot certonly --webroot -w /var/www/certbot \
                -d bantec-bank.duckdns.org \
                --email arcbank2@gmail.com \
                --agree-tos --non-interactive --no-eff-email || echo "‚ùå Fall√≥ Certbot."

              # Si se obtuvo el real, Nginx se recargar√° al final del script
            fi

            # 5. Despliegue con Docker Compose
            echo "üßπ Limpieza de im√°genes..."
            sudo docker system prune -f

            echo "üöÄ Actualizando y reiniciando todos los servicios..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            # 6. Recargar Nginx para asegurar que use el certificado m√°s reciente
            sudo docker exec nginx-proxy-bantec nginx -s reload || true

            echo "üìä Estado Final:"
            sudo docker ps

            echo "‚úÖ Deploy BANTEC completado: $(date)"
