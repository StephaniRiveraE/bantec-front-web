name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy BANTEC via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            echo "üìå Inicio de deploy BANTEC: $(date)"

            # Crear swap si no existe
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # Clonar o actualizar repositorio
            PROJECT_DIR="$HOME/BnacoBantec"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "üì• Clonando repositorio BANTEC..."
              cd ~
              git clone https://github.com/AlisonTamayo/BnacoBantec.git
            fi

            cd "$PROJECT_DIR"
            echo "üîÑ Actualizando c√≥digo desde main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # Preparar certificados
            echo "üîê Verificando certificados..."

            # mTLS para comunicaci√≥n microservices
            if [ ! -f "$PROJECT_DIR/ms-transaccion/certs/bantec-keystore.p12" ]; then
              echo "üìù Generando certificados mTLS por defecto..."
              chmod +x "$PROJECT_DIR/generate-mtls-certs.sh"
              "$PROJECT_DIR/generate-mtls-certs.sh"
            fi


            # === GESTI√ìN ROBUSTA DE SSL (M√âTODO WEBROOT) ===
            DOMAIN="bantec-bank.duckdns.org"
            
            # 1. Actualizar DNS
            echo "ÔøΩ Actualizando DNS en DuckDNS..."
            if [ -n "${{ secrets.DUCKDNS_TOKEN }}" ]; then
               curl -k "https://www.duckdns.org/update?domains=bantec-bank&token=${{ secrets.DUCKDNS_TOKEN }}&ip="
               echo "‚úÖ Solicitud de actualizaci√≥n enviada."
            else
               echo "‚ö†Ô∏è FALTAN SECRETOS DE DUCKDNS"
            fi
            
            # 2. Configurar Nginx para el dominio real
            sed -i "s/bantec-bank\.duckdns\.org/$DOMAIN/g" "$PROJECT_DIR/nginx/nginx.conf"

            CERT_DIR="$PROJECT_DIR/nginx/certs/live/$DOMAIN"
            mkdir -p "$CERT_DIR"

            # 3. Garantizar que exista AL MENOS un certificado (Dummy o Real) para que Nginx arranque
            if [ ! -f "$CERT_DIR/fullchain.pem" ]; then
                echo "‚ö†Ô∏è No se encontraron certificados. Generando DUMMY para permitir arranque de Nginx..."
                sudo openssl req -x509 -nodes -days 1 -newkey rsa:2048 \
                  -keyout "$CERT_DIR/privkey.pem" \
                  -out "$CERT_DIR/fullchain.pem" \
                  -subj "/CN=localhost"
            fi

            # 4. Levantar Servicios (Incluyendo Nginx con el cert actual)
            echo "üöÄ Levantando contenedores..."
            sudo docker-compose -f docker-compose.prod.yml down --remove-orphans
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate

            echo "‚è≥ Esperando 15s para que Nginx inicie correctamente..."
            sleep 15

            # 5. Intentar obtener/renovar certificado REAL con Certbot (Webroot)
            # Este m√©todo usa el Nginx corriendo para validar el dominio (puerto 80)
            echo "üõ°Ô∏è Ejecutando Certbot con m√©todo WEBROOT..."
            
            sudo docker-compose -f docker-compose.prod.yml run --rm --entrypoint "\
              certbot certonly --webroot -w /var/www/certbot \
              --force-renewal \
              --email arcbank2@gmail.com \
              -d $DOMAIN \
              --agree-tos \
              --non-interactive" certbot || echo "‚ö†Ô∏è Certbot fall√≥ o ya tiene certificados al d√≠a."

            # 6. Recargar Nginx para tomar el nuevo certificado (si se gener√≥)
            echo "üîÑ Recargando Nginx para aplicar certificados..."
            sudo docker-compose -f docker-compose.prod.yml exec -T nginx-proxy nginx -s reload

            # Mostrar estado final de contenedores
            echo "üìä Estado actual de contenedores:"
            sudo docker ps

            echo "‚úÖ Deploy BANTEC completado: $(date)"
