name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy BANTEC via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            echo "üìå Inicio de deploy BANTEC: $(date)"

            # Crear swap si no existe
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # Clonar o actualizar repositorio
            PROJECT_DIR="$HOME/BnacoBantec"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "üì• Clonando repositorio BANTEC..."
              cd ~
              git clone https://github.com/AlisonTamayo/BnacoBantec.git
            fi

            cd "$PROJECT_DIR"
            echo "üîÑ Actualizando c√≥digo desde main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # Preparar certificados
            echo "üîê Verificando certificados..."

            # mTLS para comunicaci√≥n microservices
            if [ ! -f "$PROJECT_DIR/ms-transaccion/certs/bantec-keystore.p12" ]; then
              echo "üìù Generando certificados mTLS por defecto..."
              chmod +x "$PROJECT_DIR/generate-mtls-certs.sh"
              "$PROJECT_DIR/generate-mtls-certs.sh"
            fi

            # Certificados SSL para Nginx (DuckDNS)
            DOMAIN="${{ secrets.DUCKDNS_DOMAIN }}.duckdns.org"
            echo "üåê Configurando dominio: $DOMAIN"
            
            # Actualizar nginx.conf con el dominio real
            sed -i "s/bantec-bank\.duckdns\.org/$DOMAIN/g" "$PROJECT_DIR/nginx/nginx.conf"
            
            echo "üåê Verificando certificados SSL para $DOMAIN..."
            CERT_DIR="$PROJECT_DIR/nginx/certs/live/$DOMAIN"
            
            if [ ! -f "$CERT_DIR/fullchain.pem" ]; then
              echo "üõ°Ô∏è Certificado real no encontrado. Intentando obtener de Let's Encrypt..."
              
              # Detener Nginx si est√° corriendo para liberar el puerto 80
              sudo docker stop nginx-proxy-bantec || true
              
              # Ejecutar Certbot Standalone
              sudo docker run --rm --name certbot \
                -p 80:80 \
                -v "$(pwd)/nginx/certs:/etc/letsencrypt" \
                -v "$(pwd)/nginx/certbot:/var/www/certbot" \
                certbot/certbot certonly --standalone \
                -d "$DOMAIN" \
                --email alison.tamayo@gmail.com \
                --agree-tos --non-interactive --no-eff-email || echo "‚ö†Ô∏è Fall√≥ la obtenci√≥n autom√°tica."

              # Fallback: Si no se obtuvo el certificado real, crear uno temporal para que Nginx arranque
              if [ ! -f "$CERT_DIR/fullchain.pem" ]; then
                echo "üìù Creando certificado temporal (self-signed) para evitar errores de Nginx..."
                sudo mkdir -p "$CERT_DIR"
                sudo openssl req -x509 -nodes -days 7 -newkey rsa:2048 \
                  -keyout "$CERT_DIR/privkey.pem" \
                  -out "$CERT_DIR/fullchain.pem" \
                  -subj "/C=EC/ST=Pichincha/L=Quito/O=Bantec/CN=$DOMAIN"
              fi
            fi

            # Limpiar Docker antes del build
            echo "üßπ Limpiando im√°genes y contenedores antiguos..."
            sudo docker image prune -f

            # Construir y levantar con docker-compose (producci√≥n)
            echo "üöÄ Reiniciando servicios y limpiando basura..."
            sudo docker-compose -f docker-compose.prod.yml down --remove-orphans
            sudo docker-compose -f docker-compose.prod.yml up -d --build --force-recreate

            # Reiniciar Nginx Proxy para aplicar certificados y configs
            echo "üîÑ Reiniciando Proxy Nginx..."
            sudo docker restart nginx-proxy-bantec || true

            # Mostrar estado final de contenedores
            echo "üìä Estado actual de contenedores:"
            sudo docker ps

            echo "‚úÖ Deploy BANTEC completado: $(date)"
