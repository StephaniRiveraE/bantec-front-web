name: Deploy BANTEC to GCP

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Debug secrets
        run: |
          echo "SSH_HOST loaded -> ${{ secrets.SSH_HOST != '' }}"
          echo "SSH_USER loaded -> ${{ secrets.SSH_USER != '' }}"
          echo "SSH_PRIVATE_KEY loaded -> ${{ secrets.SSH_PRIVATE_KEY != '' }}"

      - name: Deploy BANTEC via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          command_timeout: 45m
          script: |
            echo "üìå Inicio de deploy BANTEC: $(date)"

            # 1. Crear swap si no existe (vital para compilaci√≥n Java/React en VM peque√±a)
            if [ ! -f /swapfile ]; then
              echo "üìù Creando swap de 2GB por seguridad..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
            fi

            # 2. Clonar o actualizar repositorio
            if [ ! -d ~/BnacoBantec ]; then
              echo "üì• Clonando repositorio BANTEC..."
              cd ~
              git clone https://github.com/AlisonTamayo/BnacoBantec.git
            fi

            cd ~/BnacoBantec
            echo "üîÑ Sincronizando c√≥digo con la rama main..."
            git fetch origin main
            git reset --hard origin/main
            git config --global --add safe.directory "*"

            # 3. Preparar certificados mTLS (Comunicaci√≥n con el Switch)
            echo "üîê Verificando certificados mTLS..."
            CERT_SOURCE="~/BnacoBantec/ms-transaccion/src/main/resources/certs"
            TARGET_MTLS="~/bantec_certs"
            
            if [ ! -f $CERT_SOURCE/bantec-keystore.p12 ]; then
              echo "üõ†Ô∏è Generando nuevos certificados mTLS..."
              chmod +x ~/BnacoBantec/generate-mtls-certs.sh
              ~/BnacoBantec/generate-mtls-certs.sh
            fi
            
            # Asegurar que existan para el montaje de Docker volumes
            mkdir -p $TARGET_MTLS
            cp -r $CERT_SOURCE/* $TARGET_MTLS/
            chmod 777 $TARGET_MTLS/*

            # 4. Certificados SSL HTTPS (Let's Encrypt / DuckDNS)
            echo "üåê Verificando SSL para bantec-bank.duckdns.org..."
            # Directorios locales montados en Docker
            CERT_HOST_DIR="~/BnacoBantec/nginx/certs/live/bantec-bank.duckdns.org"
            
            if [ ! -f $CERT_HOST_DIR/fullchain.pem ]; then
              echo "üõ°Ô∏è Certificado SSL real no detectado. Intentando obtenci√≥n autom√°tica..."
              
              # Detener Nginx temporalmente para el challenge standalone (puerto 80)
              sudo docker stop nginx-proxy-bantec || true
              
              # Ejecutar Certbot Standalone
              sudo docker run --rm --name certbot \
                -p 80:80 \
                -v "$(pwd)/nginx/certs:/etc/letsencrypt" \
                -v "$(pwd)/nginx/certbot:/var/www/certbot" \
                certbot/certbot certonly --standalone \
                -d bantec-bank.duckdns.org \
                --email alison.tamayo@gmail.com \
                --agree-tos --non-interactive --no-eff-email || echo "‚ö†Ô∏è Advertencia: No se pudo obtener el certificado de Let's Encrypt."

              # Fallback de emergencia: Crear autofirmado para que Nginx no falle al arrancar
              if [ ! -f $CERT_HOST_DIR/fullchain.pem ]; then
                echo "üìù Creando certificado temporal (self-signed) como respaldo..."
                sudo mkdir -p $CERT_HOST_DIR
                sudo openssl req -x509 -nodes -days 15 -newkey rsa:2048 \
                  -keyout $CERT_HOST_DIR/privkey.pem \
                  -out $CERT_HOST_DIR/fullchain.pem \
                  -subj "/C=EC/ST=Pichincha/L=Quito/O=Bantec/CN=bantec-bank.duckdns.org"
              fi
            fi

            # 5. Despliegue con Docker Compose
            echo "üßπ Limpiando im√°genes redundantes..."
            sudo docker system prune -f

            echo "üöÄ Construyendo y levantando servicios (Modo Producci√≥n)..."
            sudo docker-compose -f docker-compose.prod.yml build --no-cache
            sudo docker-compose -f docker-compose.prod.yml up -d --force-recreate --remove-orphans

            # 6. Reiniciar Proxy para asegurar carga de configs
            echo "üîÑ Reiniciando Nginx Proxy..."
            sudo docker restart nginx-proxy-bantec || true

            echo "üìä Estado de los contenedores:"
            sudo docker ps

            echo "‚úÖ Deploy BANTEC exitoso: $(date)"
